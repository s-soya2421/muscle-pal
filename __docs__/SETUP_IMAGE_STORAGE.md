# ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ©Ÿèƒ½ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚¬ã‚¤ãƒ‰

ã“ã®ã‚¬ã‚¤ãƒ‰ã§ã¯ã€MusclePal ã®ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ©Ÿèƒ½ã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã™ã‚‹æ‰‹é †ã‚’èª¬æ˜ã—ã¾ã™ã€‚

## ğŸ“‹ å‰ææ¡ä»¶

- Supabase ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãŒä½œæˆæ¸ˆã¿
- ç’°å¢ƒå¤‰æ•° `NEXT_PUBLIC_SUPABASE_URL` ã¨ `NEXT_PUBLIC_SUPABASE_ANON_KEY` ãŒè¨­å®šæ¸ˆã¿
- Supabase CLI ã¾ãŸã¯ Supabase Dashboard ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™

## ğŸš€ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—æ‰‹é †

### 1. ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®å®Ÿè¡Œ

**1ã¤ã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã§å…¨ã¦å®Œäº†**ã—ã¾ã™ï¼š

```bash
# Supabase CLI ã‚’ä½¿ç”¨ã™ã‚‹å ´åˆ
supabase db push

# ã¾ãŸã¯ Supabase Dashboard ã§ SQL ã‚¨ãƒ‡ã‚£ã‚¿ã‹ã‚‰å®Ÿè¡Œ
# 20250824000001_complete_image_system_setup.sql
```

ã“ã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã§ä»¥ä¸‹ãŒä¸€æ‹¬å®Ÿè¡Œã•ã‚Œã¾ã™ï¼š
- âœ… Supabase Storage ãƒã‚±ãƒƒãƒˆ `posts-images` ä½œæˆ
- âœ… ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ãƒãƒªã‚·ãƒ¼è¨­å®šï¼ˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ï¼‰
- âœ… `post_images` ä¸­é–“ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ
- âœ… ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãƒ»åˆ¶ç´„ãƒ»RLSè¨­å®š
- âœ… ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°ä½œæˆ
- âœ… æ—§ã‚·ã‚¹ãƒ†ãƒ ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—

### 2. ç’°å¢ƒå¤‰æ•°ã®è¨­å®š

`.env.local` ãƒ•ã‚¡ã‚¤ãƒ«ã«ä»¥ä¸‹ã®ç’°å¢ƒå¤‰æ•°ã‚’è¿½åŠ ï¼š

```bash
# Storage Configuration
NEXT_PUBLIC_STORAGE_BASE_URL=https://your-project-id.supabase.co/storage/v1/object/public
SUPABASE_STORAGE_BUCKET=posts-images
```

**æ³¨æ„**: `your-project-id` ã‚’å®Ÿéš›ã® Supabase ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ ID ã«ç½®ãæ›ãˆã¦ãã ã•ã„ã€‚

### 3. Supabase Storage ã®ç¢ºèª

#### 3.1 Dashboard ã§ã®ç¢ºèª

1. [Supabase Dashboard](https://supabase.com/dashboard) ã«ãƒ­ã‚°ã‚¤ãƒ³
2. ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’é¸æŠ
3. **Storage** â†’ **Buckets** ã«ç§»å‹•
4. `posts-images` ãƒã‚±ãƒƒãƒˆãŒä½œæˆã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª
5. **Settings** ã§ãƒã‚±ãƒƒãƒˆãŒ **Public** ã«è¨­å®šã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª

#### 3.2 ãƒ†ã‚¹ãƒˆã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰

Dashboard ã‹ã‚‰ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦å‹•ä½œç¢ºèªï¼š

1. `posts-images` ãƒã‚±ãƒƒãƒˆã‚’é–‹ã
2. **Upload file** ã§ãƒ†ã‚¹ãƒˆç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
3. ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã® **Copy URL** ã§ URL ã‚’å–å¾—
4. ãƒ–ãƒ©ã‚¦ã‚¶ã§ URL ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ç”»åƒãŒè¡¨ç¤ºã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª

### 4. ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ†ã‚¹ãƒˆ

1. é–‹ç™ºã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•ï¼š
   ```bash
   npm run dev
   ```

2. `/posts/new` ã«ã‚¢ã‚¯ã‚»ã‚¹
3. ç”»åƒä»˜ãæŠ•ç¨¿ã‚’ä½œæˆã—ã¦ãƒ†ã‚¹ãƒˆ
4. ç”»åƒãŒæ­£ã—ãè¡¨ç¤ºã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª

## ğŸ› ï¸ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£æ¦‚è¦

### ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ§‹é€ 

```
posts                     post_images
â”œâ”€â”€ id (PK)              â”œâ”€â”€ id (PK)
â”œâ”€â”€ author_id            â”œâ”€â”€ post_id (FK â†’ posts.id)
â”œâ”€â”€ content              â”œâ”€â”€ storage_path
â”œâ”€â”€ created_at           â”œâ”€â”€ original_filename
â””â”€â”€ ...                  â”œâ”€â”€ mime_type
                         â”œâ”€â”€ file_size
                         â”œâ”€â”€ display_order
                         â””â”€â”€ created_at
```

### Storage æ§‹é€ 

```
posts-images/
â””â”€â”€ posts/
    â””â”€â”€ {user_id}/
        â”œâ”€â”€ {timestamp}-0.jpg
        â”œâ”€â”€ {timestamp}-1.jpg
        â””â”€â”€ ...
```

### URL ç”Ÿæˆæ–¹å¼

```
Base URL: https://project.supabase.co/storage/v1/object/public
Bucket:   posts-images
Path:     posts/user123/1724486400000-0.jpg
â†’ Full URL: https://project.supabase.co/storage/v1/object/public/posts-images/posts/user123/1724486400000-0.jpg
```

## ğŸ“ ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆ

### æ–°è¦ä½œæˆã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«

```
src/lib/
â”œâ”€â”€ image-upload-client.ts    # ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ç”»åƒãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
â”œâ”€â”€ image-upload-server.ts    # ã‚µãƒ¼ãƒãƒ¼å´ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼ˆãƒ¬ã‚¬ã‚·ãƒ¼ï¼‰
â”œâ”€â”€ post-images-server.ts     # ä¸­é–“ãƒ†ãƒ¼ãƒ–ãƒ«å¯¾å¿œã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
â””â”€â”€ image-utils.ts            # ç”»åƒURLç”Ÿæˆãƒ»è¡¨ç¤ºãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£

supabase/migrations/
â”œâ”€â”€ 20250824000001_add_image_paths_to_posts.sql
â”œâ”€â”€ 20250824000002_create_storage_bucket.sql
â”œâ”€â”€ 20250824000003_create_post_images_table.sql
â””â”€â”€ 20250824000004_remove_image_paths_from_posts.sql
```

### æ›´æ–°ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«

```
src/app/actions/posts.ts              # æŠ•ç¨¿ä½œæˆãƒ»å–å¾—ãƒ­ã‚¸ãƒƒã‚¯
src/app/posts/_components/            # ç”»åƒè¡¨ç¤ºã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
â”œâ”€â”€ create-post-form.tsx
â”œâ”€â”€ post-card.tsx
â””â”€â”€ post-image-gallery.tsx
.env.local.example                    # ç’°å¢ƒå¤‰æ•°ä¾‹
```

## ğŸ”§ è¨­å®šè©³ç´°

### ç”»åƒåˆ¶é™

- **æœ€å¤§ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚º**: 5MB
- **æœ€å¤§æšæ•°**: 4æš/æŠ•ç¨¿
- **å¯¾å¿œå½¢å¼**: JPEG, PNG, WebP
- **ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³**: ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ + ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å´

### ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£

- **ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰**: èªè¨¼æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã¿ã€è‡ªåˆ†ã®ãƒ•ã‚©ãƒ«ãƒ€ã®ã¿
- **èª­ã¿å–ã‚Š**: ãƒ‘ãƒ–ãƒªãƒƒã‚¯ï¼ˆæŠ•ç¨¿ã®å¯è¦–æ€§ã«å¾“ã†ï¼‰
- **å‰Šé™¤**: è‡ªåˆ†ã®ãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿
- **RLS**: post_images ãƒ†ãƒ¼ãƒ–ãƒ«ã§æŠ•ç¨¿å¯è¦–æ€§ã‚’ç¶™æ‰¿

## ğŸš¨ ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### ã‚ˆãã‚ã‚‹å•é¡Œ

1. **ãƒã‚±ãƒƒãƒˆãŒè¦‹ã¤ã‹ã‚‰ãªã„**
   ```
   Error: Bucket 'posts-images' not found
   ```
   â†’ ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ `20250824000002` ã‚’å®Ÿè¡Œ

2. **ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ¨©é™ã‚¨ãƒ©ãƒ¼**
   ```
   Error: Upload permission denied
   ```
   â†’ ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ã‚‹ã‹ç¢ºèª
   â†’ Storage ãƒãƒªã‚·ãƒ¼ãŒæ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª

3. **ç”»åƒãŒè¡¨ç¤ºã•ã‚Œãªã„**
   ```
   Error: Image failed to load
   ```
   â†’ `NEXT_PUBLIC_STORAGE_BASE_URL` ãŒæ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
   â†’ ãƒã‚±ãƒƒãƒˆãŒ Public ã«è¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª

### ãƒ‡ãƒãƒƒã‚°ç”¨ SQL

```sql
-- ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸç”»åƒã®ç¢ºèª
SELECT 
  p.id as post_id,
  p.content,
  pi.storage_path,
  pi.original_filename,
  pi.display_order
FROM posts p
LEFT JOIN post_images pi ON p.id = pi.post_id
WHERE p.author_id = 'your-user-id'
ORDER BY p.created_at DESC, pi.display_order;

-- Storage ãƒãƒªã‚·ãƒ¼ã®ç¢ºèª
SELECT * FROM storage.buckets WHERE name = 'posts-images';
SELECT * FROM storage.policies WHERE bucket_id = 'posts-images';
```

## ğŸ”„ CDN ç§»è¡Œå¯¾å¿œ

å°†æ¥çš„ã« CDN ã‚’å¤‰æ›´ã™ã‚‹å ´åˆï¼š

1. æ–°ã—ã„ CDN ã® Base URL ã‚’ç’°å¢ƒå¤‰æ•°ã§æ›´æ–°
2. ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®å†èµ·å‹•ã®ã¿ã§å®Œäº†
3. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®å¤‰æ›´ã¯ä¸è¦

```bash
# ä¾‹: Cloudflare R2 ã¸ã®ç§»è¡Œ
NEXT_PUBLIC_STORAGE_BASE_URL=https://your-domain.r2.cloudflarestorage.com/posts-images
```

## ğŸ“ ã‚µãƒãƒ¼ãƒˆ

å•é¡ŒãŒè§£æ±ºã—ãªã„å ´åˆï¼š

1. Supabase Dashboard ã® **Logs** ã§è©³ç´°ãªã‚¨ãƒ©ãƒ¼ã‚’ç¢ºèª
2. ãƒ–ãƒ©ã‚¦ã‚¶ã®é–‹ç™ºè€…ãƒ„ãƒ¼ãƒ«ã§ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ã‚’ç¢ºèª
3. ã‚µãƒ¼ãƒãƒ¼ãƒ­ã‚°ã§ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã®ã‚¨ãƒ©ãƒ¼ã‚’ç¢ºèª

---

**æœ€çµ‚æ›´æ–°**: 2025-08-24  
**ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: 1.0  
**å¯¾å¿œçŠ¶æ³**: âœ… å®Ÿè£…å®Œäº† / ãƒ†ã‚¹ãƒˆå¾…ã¡